name: macOS Build & Release

on:
  push:
    branches: [ master, main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-15

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Select Xcode 16
      run: |
        # Try to select Xcode 16.2 or fallback to latest available
        sudo xcode-select -s /Applications/Xcode_16.2.app || \
        sudo xcode-select -s /Applications/Xcode_16.1.app || \
        echo "Using default Xcode: $(xcodebuild -version)"
        xcodebuild -version

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: native/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('native/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install Pods
      run: |
        cd native
        # Clean potential bad state first
        rm -rf Pods
        pod install --repo-update

    - name: Build macOS App
      run: |
        cd native
        xcodebuild build \
          -workspace eqMac.xcworkspace \
          -scheme eqMac \
          -configuration Release \
          -destination 'platform=macOS,arch=arm64' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Package App for Release
      if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
      run: |
        cd native
        # Archive properly to get the .app
        xcodebuild archive \
          -workspace eqMac.xcworkspace \
          -scheme eqMac \
          -configuration Release \
          -destination 'platform=macOS,arch=arm64' \
          -archivePath ./build/eqMac.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -quiet

        # Extract app
        APP_PATH=$(find ./build/eqMac.xcarchive -name "eqMac.app" -type d | head -n 1)
        if [ -z "$APP_PATH" ]; then
          echo "Error: eqMac.app not found in archive"
          exit 1
        fi
        
        echo "Found app at: $APP_PATH"
        APP_NAME=$(basename "$APP_PATH")
        APP_DIR=$(dirname "$APP_PATH")
        
        # Zip it
        cd "$APP_DIR"
        zip -r "$GITHUB_WORKSPACE/DeepEyeEqMac.zip" "$APP_NAME"

    - name: Upload Build Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: DeepEyeEqMac-macos
        path: |
          DeepEyeEqMac.zip
          native/build/eqMac.xcarchive
        if-no-files-found: warn

  release-macos:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-macos
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: DeepEyeEqMac-macos
        path: .

    - name: Prepare Release Asset
      run: |
        if [ -f "DeepEyeEqMac.zip" ]; then
          mv DeepEyeEqMac.zip DeepEyeEqMac-${{ github.ref_name }}.zip
        else
          echo "No zip found to mv"
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: DeepEyeEqMac-${{ github.ref_name }}.zip
        name: DeepEyeEqMac ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}
        generate_release_notes: true
        draft: false
        prerelease: false
