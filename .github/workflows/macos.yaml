name: macOS Build & Release

on:
  push:
    branches: [ master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-15
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Select Xcode 16.2
      run: sudo xcode-select -s /Applications/Xcode_16.2.app

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Clean Caches
      run: |
        rm -rf ~/Library/Developer/Xcode/DerivedData/*
        rm -rf native/Pods
        rm -rf native/Podfile.lock

    - name: Setup CocoaPods Cache
      uses: actions/cache@v4
      with:
        path: native/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('native/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install Dependencies
      run: |
        cd native
        pod install --repo-update --verbose

    - name: Build & Archive App
      run: |
        cd native
        xcodebuild archive \
          -workspace eqMac.xcworkspace \
          -scheme eqMac \
          -configuration Release \
          -destination 'generic/platform=macOS' \
          -archivePath ./build/eqMac.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Package App
      run: |
        # Find the app and zip it
        APP_PATH=$(find native/build/eqMac.xcarchive -name "eqMac.app" -type d | head -n 1)
        if [ -z "$APP_PATH" ]; then
          echo "Error: eqMac.app not found in archive"
          exit 1
        fi
        echo "Found app at: $APP_PATH"
        APP_NAME=$(basename "$APP_PATH")
        APP_DIR=$(dirname "$APP_PATH")
        cd "$APP_DIR"
        zip -r "$GITHUB_WORKSPACE/DeepEyeEqMac.zip" "$APP_NAME"

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeepEyeEqMac-macos
        path: DeepEyeEqMac.zip
        if-no-files-found: error

  release-macos:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-macos
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: DeepEyeEqMac-macos
        path: .

    - name: Prepare Release Asset
      run: mv DeepEyeEqMac.zip DeepEyeEqMac-${{ github.ref_name }}.zip

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: DeepEyeEqMac-${{ github.ref_name }}.zip
        name: DeepEyeEqMac ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}
        generate_release_notes: true
        draft: false
        prerelease: false
