platform :osx, '13.0'
use_frameworks!
inhibit_all_warnings!

workspace 'eqMac.xcworkspace'

target 'eqMac' do
  project 'app/eqMac.xcodeproj'
  
  # --- Core dependencies ---
  pod 'EmitterKit', '~> 5.2'
  pod 'ReSwift', '~> 6.1'
  pod 'SwiftyJSON', '~> 5.0'
  pod 'SwiftyUserDefaults', '~> 5.3'
  pod 'KeychainSwift', '~> 24.0'
  pod 'Sparkle', '~> 2.6'
  pod 'Sentry', '~> 8.36'
  pod 'Zip', '~> 2.1'
  pod 'SwiftHTTP', :git => 'https://github.com/daltoniam/SwiftHTTP.git'
  # pod 'WebViewJavascriptBridge', '~> 6.0'
  pod 'STPrivilegedTask', :git => 'https://github.com/sveinbjornt/STPrivilegedTask.git', :tag => '1.0.7'

  # Use local podspec to fix missing source files in tag 3.4
  pod 'AMCoreAudio', :podspec => './AMCoreAudio.podspec'
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      # Consistent deployment target for macOS 15 SDK / Xcode 16
      config.build_settings['MACOSX_DEPLOYMENT_TARGET'] = '13.0'

      # Force module generation for AMCoreAudio
      if target.name.include?('AMCoreAudio')
        config.build_settings['DEFINES_MODULE'] = 'YES'
        config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
        config.build_settings['ENABLE_MODULE_VERIFIER'] = 'NO'
        
        # Ensure Objective-C headers are exposed to Swift
        config.build_settings['SWIFT_INSTALL_OBJC_HEADER'] = 'NO'
      end

      # Make CI signingâ€‘free
      config.build_settings['CODE_SIGN_IDENTITY'] = ''
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'

      # Robust framework search paths
      config.build_settings['FRAMEWORK_SEARCH_PATHS'] ||= ['$(inherited)']
      config.build_settings['FRAMEWORK_SEARCH_PATHS'] << '"${PODS_CONFIGURATION_BUILD_DIR}"'
      
      # Architecture settings for CI stability
      config.build_settings['ONLY_ACTIVE_ARCH'] = 'NO'
    end
  end
  # Patch AMCoreAudio for macOS 15
  puts "ðŸ”¨ Patching AMCoreAudio for macOS 15..."
  amcoreaudio_files = Dir.glob('Pods/AMCoreAudio/**/*.{m,swift}')
  amcoreaudio_files.each do |file|
    text = File.read(file)
    modified = false
    # Replace deprecated constants
    replacements = {
      'kAudioDevicePropertyDeviceIsAlive' => 'kAudioObjectPropertyOwnedObjects',
      'kAudioDevicePropertyHogMode' => 'kAudioDevicePropertyDeviceIsRunningSomewhere',
      'import CoreAudio.AudioHardwareBase' => 'import CoreAudio',
      '@import CoreAudio.AudioHardware;' => '@import CoreAudio;',
    }
    replacements.each do |old, new|
      if text.include?(old)
        text.gsub!(old, new)
        modified = true
      end
    end
    File.write(file, text) if modified
  end
end
